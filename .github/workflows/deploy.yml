name: Deploy Automatico T-FlightOps

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Baixar código atualizado
      uses: actions/checkout@v4

    - name: Atualizar Aplicação no Servidor
      shell: powershell
      run: |
        # --- CONFIGURAÇÕES ---
        $AppPath = "C:\ProjetosPython\T-FlightOps"
        $nssmPath = "C:\nssm-2.24\win64\nssm.exe"
        $LogFile = "C:\actions-runner\deploy-log.txt"
        
        # Inicia Log
        Start-Transcript -Path $LogFile -Append
        Write-Host "--- DEPLOY LINEAR INICIADO: $(Get-Date) ---"

        # Garante que erros de comando não matem o script imediatamente, nós vamos checar manualmente
        $ErrorActionPreference = "Continue"

        # -----------------------------------------------------------
        # 1. PARAR SERVIÇO
        # -----------------------------------------------------------
        Write-Host "1. Parando serviço $ServiceName..."
        # Tenta parar. Se der erro (ex: já estava parado), apenas avisa e continua.
        & $nssmPath stop $ServiceName
        Start-Sleep -Seconds 5

        # -----------------------------------------------------------
        # 2. LIMPEZA
        # -----------------------------------------------------------
        Write-Host "2. Limpando arquivos antigos..."
        if (Test-Path $AppPath) {
            Get-ChildItem -Path $AppPath -Exclude ".venv", ".git", ".env" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        } else {
            New-Item -ItemType Directory -Force -Path $AppPath
        }

        # -----------------------------------------------------------
        # 3. COPIA
        # -----------------------------------------------------------
        Write-Host "3. Copiando arquivos..."
        Copy-Item -Path ".\*" -Destination $AppPath -Recurse -Force -Exclude ".git", ".github"
        
        # Verifica se a cópia funcionou
        if (-not (Test-Path "$AppPath\WSGI.py")) {
            Write-Error "ERRO FATAL: Arquivos não foram copiados corretamente."
            Stop-Transcript
            exit 1
        }

        # -----------------------------------------------------------
        # 4. INSTALAÇÃO (PIP)
        # -----------------------------------------------------------
        Write-Host "4. Instalando dependências..."
        Set-Location $AppPath
        if (Test-Path ".venv\Scripts\python.exe") {
            # Roda o PIP. Se tiver avisos (amarelo), ele mostra mas não trava.
            & .\.venv\Scripts\python.exe -m pip install -r requirements.txt
            
            # Checa se o PIP quebrou de verdade (ExitCode diferente de 0)
            if ($LASTEXITCODE -ne 0) {
                Write-Error "ERRO FATAL: Falha ao instalar requirements.txt"
                Stop-Transcript
                exit 1
            }
        } else {
            Write-Error "ERRO FATAL: .venv não encontrada!"
            Stop-Transcript
            exit 1
        }

        # -----------------------------------------------------------
        # 5. INICIAR SERVIÇO
        # -----------------------------------------------------------
        Write-Host "5. Iniciando serviço $ServiceName..."
        & $nssmPath start $ServiceName
        
        # Espera um pouco para ver se o serviço firma
        Start-Sleep -Seconds 5
        
        # Verifica se o serviço está rodando
        $ServiceStatus = Get-Service $ServiceName
        if ($ServiceStatus.Status -ne 'Running') {
            Write-Warning "ATENÇÃO: O serviço parece não ter iniciado corretamente. Status: $($ServiceStatus.Status)"
            # Não vamos dar exit 1 aqui para tentar reiniciar o Nginx mesmo assim
        }

        # -----------------------------------------------------------
        # 6. REINICIAR NGINX
        # -----------------------------------------------------------
        Write-Host "6. Reiniciando Nginx..."
        & $nssmPath restart "Nginx" -ErrorAction Continue

        Write-Host "--- DEPLOY CONCLUÍDO ---"
        Stop-Transcript
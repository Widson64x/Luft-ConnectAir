name: Deploy Automatico T-FlightOps

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Baixar código atualizado
      uses: actions/checkout@v4

    - name: Atualizar Aplicação no Servidor
      shell: powershell
      run: |
        # --- CONFIGURAÇÃO DE LOG ---
        $LogFile = "C:\actions-runner\deploy-log.txt"
        Start-Transcript -Path $LogFile -Append
        Write-Host "--- NOVO DEPLOY INICIADO: $(Get-Date) ---"

        # Define preferência de erro para parar o script se algo grave acontecer
        $ErrorActionPreference = "Stop"

        try {
            # --- SEUS CAMINHOS ---
            $ServiceName = "Luft-FlightOps"
            $AppPath = "C:\ProjetosPython\T-FlightOps"
            $nssmPath = "C:\nssm-2.24\win64\nssm.exe"

            # 1. Parar o serviço Python
            Write-Host "1. Parando serviço $ServiceName..."
            if (Get-Service $ServiceName -ErrorAction SilentlyContinue) {
                # Usamos cmd /c aqui também para evitar erros falsos no stop
                cmd /c "$nssmPath stop $ServiceName"
                Start-Sleep -Seconds 5
            } else {
                Write-Host "Serviço não estava rodando."
            }

            # 2. Limpar a pasta (Protegendo .venv e .git)
            Write-Host "2. Limpando arquivos antigos..."
            if (Test-Path $AppPath) {
                Get-ChildItem -Path $AppPath -Exclude ".venv", ".git" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
            } else {
                New-Item -ItemType Directory -Force -Path $AppPath
            }

            # 3. Copiar os arquivos novos
            Write-Host "3. Copiando nova versão..."
            Copy-Item -Path ".\*" -Destination $AppPath -Recurse -Force -Exclude ".git", ".github"

            # 4. Instalar dependências (CORREÇÃO DO ERRO AQUI)
            Write-Host "4. Instalando bibliotecas (pip)..."
            Set-Location $AppPath
            if (Test-Path ".venv\Scripts\python.exe") {
                # O comando 'cmd /c' blinda o script contra avisos amarelos do pip
                cmd /c ".\.venv\Scripts\python.exe -m pip install -r requirements.txt"
                
                # Verificamos se deu erro real (código diferente de 0)
                if ($LASTEXITCODE -ne 0) { throw "Erro fatal ao instalar dependências via PIP." }
            } else {
                throw "A pasta .venv não existe em $AppPath! O deploy falhou."
            }

            # 5. Reiniciar Serviço Python
            Write-Host "5. Iniciando serviço $ServiceName..."
            cmd /c "$nssmPath start $ServiceName"

            # 6. Reiniciar Nginx
            Write-Host "6. Reiniciando Nginx..."
            Restart-Service "nginx" -ErrorAction Continue # Se o Nginx falhar, não mata o deploy, apenas avisa

            Write-Host "--- DEPLOY CONCLUÍDO COM SUCESSO ---"
        
        } catch {
            Write-Error "!!! ERRO FATAL DURANTE O DEPLOY !!!"
            Write-Error $_
            Write-Error $_.ScriptStackTrace
            exit 1
        } finally {
            Write-Host "--- FIM DO LOG ---"
            Stop-Transcript
        }